---
title: "New data"
author: "ruby"
date: "2024-11-08"
output: pdf_document
---
#Set up
```{r}
if(!require("pacman")) install.packages("pacman")
pacman::p_load(data.table, lubridate, ggplot2, patchwork, readxl, readr, RACFfunctions, scales, utils)
options(scipen = 100)
```

```{r}
source("~/Documents/GitHub/SustainableMotoringIndex/KSIs/LoadingSeverityData.R")

MilesByVehicleType <- as.data.table(read_excel("~/Documents/GitHub/SustainableMotoringIndex/KSIs/tra0101-miles-by-vehicle-type.xlsx", sheet = "TRA0101", skip = 4))

download("https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatestimeseriesdataset/current/upload-pop.csv", "~/Documents/GitHub/RubyMotoringIndex/CSV/PopulationEst.csv")

Population <- fread("CSV/PopulationEst.csv")
Population <- Population[8:62,]
setnames(Population, c("Title", "Scotland population mid-year estimate", "Great Britain population mid-year estimate", "England population mid-year estimate", "England and Wales population mid-year estimate", "United Kingdom population mid-year estimate", "Northern Ireland population mid-year estimate", "Wales population mid-year estimate"), c("Year", "Scotland", "Great Britain", "England", "England and Wales", "United Kingdom", "Northern Ireland", "Wales"))
Population <- Population[, lapply(.SD, as.numeric), .SDcols = c("Scotland", "Great Britain", "England", "England and Wales", "United Kingdom", "Northern Ireland", "Wales"), by = c("Year")]

Population <- Population[, Year:=as.Date.character(Year, tryFormats = "%Y")]

TotalMilesDriven <- MilesByVehicleType[,.(Year, `All Motor Vehicles`)]
TotalMilesDriven <- TotalMilesDriven[, Year:=(as.Date(paste0(Year, "-01-01"), tryFormats = "%Y"))]

TotalMilesDriven <- merge(TotalMilesDriven, Population, by = "Year", all= TRUE)
TotalMilesDriven <- TotalMilesDriven[,"Population (GB)":=`Great Britain`]
TotalMilesDriven <- TotalMilesDriven[,.(Year, `All Motor Vehicles`, `Population (GB)`)]
```

```{r}
CasualtybyYear <- cas.df[collision_year < 2004 & !casualty_severity == "Slight", .N, keyby=c("collision_year", "casualty_severity")]

tester <- cas.df[collision_year>=2004 & !casualty_severity == "Fatal" & !(casualty_adjusted_severity_slight == 1), .(collision_year, casualty_severity, casualty_adjusted_severity_serious, casualty_adjusted_severity_slight)]

tester <- tester[,lapply(.SD, sum), .SDcols = c("casualty_adjusted_severity_serious"), by = c("collision_year")]
tester <- tester[, "casualty_severity":="Serious"]
setnames(tester, "casualty_adjusted_severity_serious", "N")

tester2 <- cas.df[collision_year>=2004 & casualty_severity == "Fatal", .(collision_year, casualty_severity, casualty_adjusted_severity_serious, casualty_adjusted_severity_slight)]
tester2 <- tester2[,.N, keyby = c("collision_year")]
tester2 <- tester2[, "casualty_severity":="Fatal"]

CasualtybyYear <- merge(CasualtybyYear, tester, by =c("collision_year", "casualty_severity", "N"), all = TRUE)
CasualtybyYear <- merge(CasualtybyYear, tester2, by =c("collision_year", "casualty_severity", "N"), all = TRUE)
rm(tester, tester2)

temp <- CasualtybyYear
temp <- temp[,lapply(.SD, sum), .SDcols = "N", by = "collision_year"][, "casualty_severity":="KSI"]
CasualtybyYear <- merge(CasualtybyYear, temp, by = c("collision_year", "N", "casualty_severity"), all = TRUE)
```

```{r}
KSIandMileage <- merge(MilesByVehicleType[,.(Year,`All Motor Vehicles`)], CasualtybyYear, by.x ="Year" , by.y = "collision_year", all = TRUE)
KSIandMileage <- KSIandMileage[!is.na(casualty_severity)]


KSIandMileage <- KSIandMileage[, "Rate":= N / `All Motor Vehicles`]
```

#Graphs 
```{r}
ggplot(KSIandMileage, aes(x = Year, y = N, colour = casualty_severity)) +
  geom_line() +
  theme_classic() +
  labs(title = "Casualties and fatalities by year", x = "Year", y = "Totals", caption = "In 2004 there was a change in methodology to improve the\n accuracy of the seriousness of injuries reported, adjusted severity rates are the \nresult of this, shown by the data on the right of the dotted line.") +
  scale_color_manual("", values = .CasualtyColours) +
    geom_vline(xintercept=2004, color="black", linewidth =0.5, linetype = "dashed") +
    scale_x_continuous(n.breaks = 10, expand=c(0,0)) + 
  scale_y_continuous(expand = c(0,0), labels = scales::comma, n.breaks = 10) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5), axis.text.x=element_text(angle = 45, hjust=1), plot.caption = element_text(face = "italic"), legend.position = "bottom")
```

```{r}
ggplot(KSIandMileage, aes(x = Year, y = Rate, colour = casualty_severity, linetype = casualty_severity)) + 
  geom_line() + 
  theme_classic() + 
  scale_color_manual(" ", values = .CasualtyColours) + 
  scale_linetype_manual(" ", values = .CasualtyLines) +
  geom_vline(xintercept=2004, color="black", linewidth=0.2, linetype = "dashed") +
  scale_x_continuous(n.breaks = 10, expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0), labels = scales::comma, n.breaks = 10) +
  labs(x= "Year", y = "Casualties/ fatalities per billion miles", title = "Fatalities and serious injuries per one billion motor vehicle miles travelled", caption = "In 2004 there was a change in methodology to improve the accuracy of the seriousness of injuries reported. \nAdjusted severity rates are the result of this, shown by the data on the right of the dotted line.") +
  theme(plot.title = element_text(face = "bold", hjust = 0.5), axis.text.x=element_text(angle = 45, hjust=1), plot.caption = element_text(face = "italic"), legend.position = "bottom")
```


```{r}
ggplot(KSIandMileage[casualty_severity=="KSI",], aes(x = Year, y = Rate, colour = casualty_severity)) + 
  geom_line()+
  theme_classic() + 
  labs(title = "Fatalities and serious injuries per one billion motor vehicle miles", x = "Year", y = "Rate", caption = "In 2004 there was a change in methodology to improve the accuracy of the seriousness of injuries reported. \nAdjusted severity rates are the result of this, shown by the data on the right of the dotted line.") +
  scale_color_manual(" ", values = .CasualtyColours)  +
  theme(plot.title = element_text(face = "bold", hjust = 0.5), axis.text.x=element_text(angle = 45, hjust=1), plot.caption = element_text(face = "italic"), legend.position = "bottom") +
    geom_vline(xintercept=2004, color="black", linewidth =0.5, linetype = "dashed") +
    scale_x_continuous(n.breaks = 10, expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0), labels = scales::comma, n.breaks = 10)
```
#Unadjusted KSI graph
```{r}
UnadjustedKSI <- datatable[,.N, keyby = c("Year", "casualty_severity")]
UnadjustedKSI <- merge(subset(UnadjustedKSI, UnadjustedKSI$casualty_severity == "Fatal"), subset(UnadjustedKSI, UnadjustedKSI$casualty_severity == "Serious"), by = "Year", all = TRUE)
setnames(UnadjustedKSI, c("N.x", "N.y"), c("Fatalities", "Casualties"))
UnadjustedKSI[, c("casualty_severity.x", "casualty_severity.y") := NULL]
UnadjustedKSI <- UnadjustedKSI[, Year:= seq(from = as.Date("1979-01-01"), to = as.Date("2023-01-01"), by = "year")]
```

```{r}
UnadjustedKSI <- UnadjustedKSI[, KSI:= Casualties + Fatalities]
UnadjustedKSI <- merge(TotalMilesDriven, UnadjustedKSI, by = "Year", all= TRUE)
UnadjustedKSI <- UnadjustedKSI[, FatalityRate := Fatalities / All_motor_veh][, CasualtyRate := Casualties / All_motor_veh][, KSIRate := KSI / All_motor_veh][!is.na(Fatalities),][, Year:= year(Year)]
```

UnadjustedKSIPlot <- 
UnadjustedKSIPlot2004 <- 
```{r}
UnadjustedKSI2 <- UnadjustedKSI[ Year >= 2004,]

ggplot() + 
  geom_line(data = UnadjustedKSI, aes(y = FatalityRate, x= Year, colour = "Fatality (killed)", linetype = "Fatality (killed)")) + 
  geom_line(data = UnadjustedKSI, aes(y = CasualtyRate, x= Year, colour = "Casualty (serious injury)", linetype = "Casualty (serious injury)")) + 
  geom_line(data = UnadjustedKSI, aes(y = KSIRate, x= Year, colour = "Fatality or casualty (killed or seriously injured)", linetype = "Fatality or casualty (killed or seriously injured)")) +
  theme_classic() + 
  ggtitle("UNADJUSTED Fatalities and serious injuries 
          per one billion motor vehicle miles travelled") + 
  ylab("Casualties/ fatalities per billion miles") + 
  scale_color_manual("Unadjusted casuality severity levels", values = CasualtyColours) + 
  xlab("End of year") + 
  scale_linetype_manual("Unadjusted casuality severity levels", values = CasualtyLines) +
  theme(legend.position = "bottom", legend.title.position = "top", legend.text.position = "top", legend.key = element_rect(fill = "white", colour = "black", ), axis.text.x=element_text(angle=60, hjust=1), plot.title = element_text(face = "bold", hjust = 0.5), plot.caption = element_text(hjust = 0, face = "italic")) + 
  scale_x_continuous(breaks = pretty(Ksi3$Year, n = 10), expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) 

ggplot() + 
  geom_line(data = UnadjustedKSI2, aes(y = FatalityRate, x= Year, colour = "Fatality (killed)", linetype = "Fatality (killed)")) + 
  geom_line(data = UnadjustedKSI2, aes(y = CasualtyRate, x= Year, colour = "Casualty (serious injury)", linetype = "Casualty (serious injury)")) + 
  geom_line(data = UnadjustedKSI2, aes(y = KSIRate, x= Year, colour = "Fatality or casualty (killed or seriously injured)", linetype = "Fatality or casualty (killed or seriously injured)")) +
  theme_classic() + 
  ggtitle("UNADJUSTED Fatalities and serious injuries 
          per one billion motor vehicle miles travelled:2004 onwards") + 
  ylab("Casualties/ fatalities per billion miles") + 
  scale_color_manual("Unadjusted casuality severity levels", values = CasualtyColours) + 
  xlab("End of year") + 
  scale_linetype_manual("Unadjusted casuality severity levels", values = CasualtyLines) +
  theme(legend.position = "bottom", legend.title.position = "top", legend.text.position = "top", legend.key = element_rect(fill = "white", colour = "black", ), axis.text.x=element_text(angle=60, hjust=1), plot.title = element_text(face = "bold", hjust = 0.5), plot.caption = element_text(hjust = 0, face = "italic")) + 
  scale_x_continuous(breaks = pretty(Ksi3$Year, n = 10), expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) 


```
ggsave("UnadjustedKSIPlot2004.pdf")
ggsave("UnadjustedKSIPlot.pdf")

#KSIs by population

KSIbyGBPopulation <- 
```{r}
Ksi3 <- Ksi3[, FatalitybyPop:= Fatalities / (Population / 100000)]
Ksi3 <- Ksi3[, Casualtybypop:= Casualties / (Population / 100000)]
Ksi3 <- Ksi3[, KSIbypop := KSI / (Population / 100000)]

ggplot() + 
  geom_line(data = Ksi3, aes(y = FatalitybyPop, x= Year, colour = "Fatality (killed)", linetype = "Fatality (killed)")) + 
  geom_line(data =Ksi3 , aes(y = Casualtybypop, x= Year, colour = "Casualty (serious injury)", linetype = "Casualty (serious injury)")) + 
  geom_line(data = Ksi3, aes(y = KSIbypop, x= Year, colour = "Fatality or casualty (killed or seriously injured)", linetype = "Fatality or casualty (killed or seriously injured)")) +
  theme_classic() + 
  ggtitle("Fatalities and serious injuries per 100k in GB Population") + 
  ylab("Casualties/ fatalities per population") + 
  scale_color_manual("Casuality severity levels", values = CasualtyColours) + 
  xlab("End of year") + 
  scale_linetype_manual("Casuality severity levels", values = CasualtyLines) +
  theme(legend.position = "bottom", legend.title.position = "top", legend.text.position = "top", legend.key = element_rect(fill = "white", colour = "black", ), axis.text.x=element_text(angle=60, hjust=1), plot.title = element_text(face = "bold", hjust = 0.5), plot.caption = element_text(hjust = 0, face = "italic")) +
  geom_vline(xintercept=2004, color="black", linewidth=0.2, linetype = "dashed")  + 
  scale_x_continuous(breaks = pretty(Ksi3$Year, n = 10), expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  labs(caption = "*In 2004 there was a change in methodology to improve the accuracy of the seriousness \n of injuries reported, adjusted severity rates are the result of this.")

```
ggsave("KSIbyGBPopulation.pdf")
